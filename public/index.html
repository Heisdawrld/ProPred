<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROPRED ‚Äî Predict Smarter</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --black:#04040a;--surface:#0a0a12;--card:#0f0f1a;
  --border:#1c1c2e;--muted:#252535;--text:#e6e6f0;--dim:#5a5a78;
  --gold:#f0c040;--gold2:#f5d060;--gold-dim:rgba(240,192,64,.1);--gold-glow:rgba(240,192,64,.2);
  --green:#00e676;--green-dim:rgba(0,230,118,.08);
  --red:#ff4455;--red-dim:rgba(255,68,85,.08);
  --blue:#4da6ff;--blue-dim:rgba(77,166,255,.08);
  --orange:#ff7040;--purple:#9d6fff;
}
html{scroll-behavior:smooth}
body{background:var(--black);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;overflow-x:hidden}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9998;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");opacity:.5}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--black)}::-webkit-scrollbar-thumb{background:var(--muted);border-radius:3px}

nav{position:fixed;top:0;left:0;right:0;z-index:200;height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 2rem;background:rgba(4,4,10,.92);backdrop-filter:blur(24px);border-bottom:1px solid var(--border)}
.logo{font-family:'Bebas Neue',sans-serif;font-size:1.9rem;letter-spacing:5px;background:linear-gradient(135deg,#f0c040,#fff8d0,#f0c040);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;cursor:pointer}
.nav-right{display:flex;align-items:center;gap:1.2rem;flex-wrap:wrap}
.nav-link{color:var(--dim);font-size:.78rem;font-weight:500;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;transition:color .2s;background:none;border:none;padding:0}
.nav-link:hover{color:var(--text)}
.nav-pill{display:flex;align-items:center;gap:.4rem;padding:.25rem .75rem;border-radius:20px;font-size:.65rem;font-weight:700;letter-spacing:1px;font-family:'Space Mono',monospace}
.pill-live{background:var(--green-dim);border:1px solid rgba(0,230,118,.25);color:var(--green)}
.pill-error{background:var(--red-dim);border:1px solid rgba(255,68,85,.3);color:var(--red)}
.pill-date{background:var(--muted);border:1px solid var(--border);color:var(--dim)}
input[type=date]{background:transparent;border:none;color:var(--dim);font-size:.65rem;font-family:'Space Mono',monospace;outline:none;cursor:pointer;max-width:100px}
input[type=date]::-webkit-calendar-picker-indicator{filter:invert(1) opacity(.4);cursor:pointer}
.pdot{width:5px;height:5px;border-radius:50%;background:var(--green);animation:pulse 1.4s infinite;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.7)}}

.ticker{background:linear-gradient(90deg,var(--gold),#f5d060,var(--gold));color:var(--black);height:30px;display:flex;align-items:center;overflow:hidden;margin-top:60px}
.ticker-track{display:flex;animation:tick 50s linear infinite;white-space:nowrap;font-size:.65rem;font-weight:700;letter-spacing:2px;text-transform:uppercase}
@keyframes tick{from{transform:translateX(0)}to{transform:translateX(-50%)}}
.ticker-item{padding:0 2.5rem;flex-shrink:0}

.hero{position:relative;overflow:hidden;padding:4.5rem 2rem 3.5rem;text-align:center;background:radial-gradient(ellipse 100% 70% at 50% 0%,rgba(240,192,64,.05) 0%,transparent 70%)}
.hero-grid{position:absolute;inset:0;background-image:linear-gradient(rgba(240,192,64,.022) 1px,transparent 1px),linear-gradient(90deg,rgba(240,192,64,.022) 1px,transparent 1px);background-size:50px 50px;mask-image:radial-gradient(ellipse 90% 80% at 50% 30%,black 30%,transparent 100%)}
.hero-eyebrow{display:inline-flex;align-items:center;gap:.5rem;padding:.3rem 1rem;border-radius:20px;background:var(--gold-dim);border:1px solid rgba(240,192,64,.2);color:var(--gold);font-size:.68rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:1.5rem;animation:fadeUp .5s ease both}
.hero h1{font-family:'Bebas Neue',sans-serif;font-size:clamp(3.5rem,9vw,7.5rem);line-height:.88;letter-spacing:2px;background:linear-gradient(180deg,#fff 0%,rgba(255,255,255,.5) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:fadeUp .5s .08s ease both}
.hero h1 em{font-style:normal;background:linear-gradient(135deg,var(--gold),#fff5c0);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero p{font-size:.95rem;color:var(--dim);margin:1.2rem auto 0;max-width:460px;line-height:1.7;animation:fadeUp .5s .16s ease both}
.hero-btns{display:flex;justify-content:center;gap:.8rem;margin-top:2rem;flex-wrap:wrap;animation:fadeUp .5s .24s ease both}
.btn{padding:.7rem 1.6rem;border-radius:8px;font-weight:600;font-size:.82rem;cursor:pointer;transition:all .2s;border:none}
.btn-gold{background:var(--gold);color:var(--black);box-shadow:0 4px 20px var(--gold-glow)}
.btn-gold:hover{background:var(--gold2);transform:translateY(-2px);box-shadow:0 8px 30px var(--gold-glow)}
.btn-outline{background:transparent;color:var(--text);border:1px solid var(--border)}
.btn-outline:hover{border-color:var(--dim);background:var(--muted)}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

.stats-bar{display:flex;justify-content:center;border-top:1px solid var(--border);border-bottom:1px solid var(--border);background:var(--surface);flex-wrap:wrap}
.stat-item{padding:1rem 2rem;text-align:center;border-right:1px solid var(--border);flex:1;min-width:100px}
.stat-item:last-child{border-right:none}
.stat-n{font-family:'Bebas Neue',sans-serif;font-size:1.9rem;letter-spacing:2px;color:var(--gold);line-height:1}
.stat-l{font-size:.58rem;color:var(--dim);text-transform:uppercase;letter-spacing:2px;margin-top:3px}

.main-wrap{max-width:1380px;margin:0 auto;padding:2.5rem 1.5rem;display:grid;grid-template-columns:1fr 310px;gap:2rem}
@media(max-width:960px){.main-wrap{grid-template-columns:1fr}.sidebar{order:-1}}

.sec-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;gap:1rem;flex-wrap:wrap}
.sec-title{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:3px}
.sec-meta{font-family:'Space Mono',monospace;font-size:.65rem;color:var(--dim)}

.date-bar{display:flex;gap:.4rem;margin-bottom:1.5rem;overflow-x:auto;padding-bottom:.3rem}
.date-chip{display:flex;flex-direction:column;align-items:center;padding:.55rem .85rem;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--dim);cursor:pointer;transition:all .2s;min-width:54px}
.date-chip:hover{border-color:var(--dim);color:var(--text)}
.date-chip.active{background:var(--gold);color:var(--black);border-color:var(--gold);font-weight:700}
.date-chip-day{font-size:.55rem;letter-spacing:1px;text-transform:uppercase}
.date-chip-num{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;line-height:1;margin-top:1px}

.filter-row{display:flex;gap:.4rem;margin-bottom:1.5rem;flex-wrap:wrap}
.ftab{padding:.35rem .85rem;border-radius:5px;border:1px solid var(--border);background:transparent;color:var(--dim);font-size:.68rem;font-weight:600;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:all .2s}
.ftab:hover{border-color:var(--dim);color:var(--text)}
.ftab.on{background:var(--gold);color:var(--black);border-color:var(--gold)}

.lg-div{display:flex;align-items:center;gap:.7rem;margin:1.8rem 0 .9rem;opacity:.7}
.lg-div-line{flex:1;height:1px;background:var(--border)}
.lg-div-label{font-size:.62rem;text-transform:uppercase;letter-spacing:2px;color:var(--dim);white-space:nowrap;display:flex;align-items:center;gap:.4rem}

.loader{text-align:center;padding:3rem 2rem}
.spinner{width:36px;height:36px;border:2px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto .8rem}
@keyframes spin{to{transform:rotate(360deg)}}
.loader-text{font-size:.78rem;color:var(--dim);letter-spacing:1px}
.load-sub{font-size:.65rem;color:var(--muted);margin-top:.3rem}

.ai-banner{display:flex;align-items:center;gap:.6rem;padding:.55rem .9rem;border-radius:6px;background:rgba(157,111,255,.05);border:1px solid rgba(157,111,255,.15);margin-bottom:1.2rem;font-size:.7rem;color:var(--purple)}
.ai-dots span{display:inline-block;width:3px;height:3px;border-radius:50%;background:var(--purple);margin-left:2px;animation:db 1.2s infinite}
.ai-dots span:nth-child(2){animation-delay:.2s}.ai-dots span:nth-child(3){animation-delay:.4s}
@keyframes db{0%,80%,100%{transform:translateY(0);opacity:.3}40%{transform:translateY(-4px);opacity:1}}

.pcard{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:.9rem;transition:transform .25s,box-shadow .25s}
.pcard:hover{transform:translateY(-2px);box-shadow:0 10px 40px rgba(0,0,0,.5)}
.pcard.val{border-left:3px solid var(--gold)}.pcard.val:hover{box-shadow:0 10px 40px rgba(0,0,0,.5),0 0 30px rgba(240,192,64,.06)}
.pcard.safe{border-left:3px solid var(--green)}.pcard.safe:hover{box-shadow:0 10px 40px rgba(0,0,0,.5),0 0 30px rgba(0,230,118,.05)}
.pcard.avoid{border-left:3px solid var(--red)}
.pcard.reliable{border-left:3px solid var(--blue)}

/* Win probability bar */
.prob-bar{display:flex;height:5px;border-radius:3px;overflow:hidden;margin:0 1.2rem .85rem;gap:2px}
.prob-h{background:var(--blue);border-radius:2px;transition:width .8s ease}
.prob-d{background:#3a3a55;border-radius:2px;transition:width .8s ease}
.prob-a{background:var(--orange);border-radius:2px;transition:width .8s ease}
.prob-labels{display:flex;justify-content:space-between;padding:0 1.2rem;margin-bottom:.7rem}
.prob-lbl{font-family:'Space Mono',monospace;font-size:.58rem;color:var(--dim)}
.prob-lbl span{font-weight:700;color:var(--text)}

/* Progress counter */
.load-progress{text-align:center;padding:.5rem;font-family:'Space Mono',monospace;font-size:.65rem;color:var(--purple);margin-bottom:.5rem}
.prog-bar-wrap{width:100%;height:2px;background:var(--muted);border-radius:1px;margin:.4rem 0}
.prog-bar-fill{height:100%;background:var(--gold);border-radius:1px;transition:width .3s ease}

/* Top picks banner */
.top-picks{background:linear-gradient(135deg,rgba(240,192,64,.06),rgba(240,192,64,.02));border:1px solid rgba(240,192,64,.2);border-radius:12px;padding:1.1rem 1.2rem;margin-bottom:1.5rem}
.tp-title{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:3px;color:var(--gold);margin-bottom:.8rem;display:flex;align-items:center;gap:.5rem}
.tp-list{display:flex;flex-direction:column;gap:.45rem}
.tp-row{display:flex;align-items:center;gap:.7rem;padding:.5rem .7rem;background:rgba(0,0,0,.25);border-radius:7px;border:1px solid var(--border);cursor:pointer;transition:border-color .2s}
.tp-row:hover{border-color:var(--gold)}
.tp-rank{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;color:var(--gold);min-width:18px}
.tp-match{flex:1;font-size:.72rem;font-weight:600}
.tp-tip{font-size:.65rem;color:var(--dim);flex:1}
.tp-conf{font-family:'Space Mono',monospace;font-size:.7rem;font-weight:700;color:var(--green)}

/* Richer stats grid */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:.55rem;margin-bottom:.9rem}
.stat-box{background:var(--card);border:1px solid var(--border);border-radius:7px;padding:.6rem .75rem;text-align:center}
.sb-val{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;line-height:1}
.sb-lbl{font-size:.55rem;text-transform:uppercase;letter-spacing:1px;color:var(--dim);margin-top:2px}
.xg-row{display:flex;align-items:center;gap:.5rem;padding:.5rem .7rem;background:var(--card);border:1px solid var(--border);border-radius:7px;margin-bottom:.55rem;font-size:.7rem}
.xg-team{flex:1;color:var(--dim)}
.xg-val{font-family:'Space Mono',monospace;font-weight:700;font-size:.8rem}
.xg-bar{flex:2;height:4px;background:var(--muted);border-radius:2px;overflow:hidden}
.xg-fill{height:100%;border-radius:2px;background:var(--gold)}

.card-head{padding:.9rem 1.2rem .8rem}
.card-meta-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:.8rem;gap:.4rem;flex-wrap:wrap}
.league-tag{display:flex;align-items:center;gap:.4rem;font-size:.65rem;color:var(--dim);text-transform:uppercase;letter-spacing:1px}

.badges{display:flex;gap:.3rem;flex-wrap:wrap}
.bdg{display:inline-flex;align-items:center;gap:.2rem;padding:.16rem .5rem;border-radius:20px;font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;white-space:nowrap}
.bdg-val{background:var(--gold-dim);color:var(--gold);border:1px solid rgba(240,192,64,.25)}
.bdg-safe{background:var(--green-dim);color:var(--green);border:1px solid rgba(0,230,118,.2)}
.bdg-avoid{background:var(--red-dim);color:var(--red);border:1px solid rgba(255,68,85,.2)}
.bdg-rel{background:var(--blue-dim);color:var(--blue);border:1px solid rgba(77,166,255,.2)}
.bdg-hot{background:rgba(255,112,64,.1);color:var(--orange);border:1px solid rgba(255,112,64,.2)}
.bdg-risky{background:rgba(255,68,85,.06);color:#ff8899;border:1px solid rgba(255,68,85,.18)}
.bdg-live{background:var(--green-dim);color:var(--green);border:1px solid rgba(0,230,118,.3);animation:bpulse 1.5s infinite}
@keyframes bpulse{0%,100%{opacity:1}50%{opacity:.5}}

.teams-row{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:.7rem;margin-bottom:.7rem}
.team{display:flex;align-items:center;gap:.55rem}
.team.away{flex-direction:row-reverse;text-align:right}
.crest{width:36px;height:36px;border-radius:50%;background:var(--muted);display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:700;flex-shrink:0;color:var(--dim)}
.team-name{font-weight:600;font-size:.85rem;line-height:1.25}
.team-form{display:flex;gap:2px;margin-top:3px}
.team.away .team-form{justify-content:flex-end}
.fd{width:7px;height:7px;border-radius:2px}
.fd.W{background:var(--green)}.fd.D{background:#444}.fd.L{background:var(--red)}
.vs-mid{text-align:center}
.vs-time{font-family:'Space Mono',monospace;font-size:.65rem;color:var(--dim);margin-bottom:2px}
.vs-sep{font-family:'Bebas Neue',sans-serif;font-size:1rem;color:var(--muted);letter-spacing:3px;line-height:1}
.live-score{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;color:var(--gold);letter-spacing:3px;line-height:1}

.insight{padding:.75rem 1.2rem;border-top:1px solid var(--border);background:rgba(240,192,64,.025)}
.insight-lbl{font-size:.57rem;text-transform:uppercase;letter-spacing:2px;color:var(--gold);margin-bottom:.25rem}
.insight-txt{font-size:.75rem;color:var(--dim);line-height:1.65}
.insight.av{background:rgba(255,68,85,.025)}
.insight.av .insight-lbl{color:var(--red)}

.pred-row{display:flex;align-items:center;justify-content:space-between;gap:1rem;padding:.8rem 1.2rem;border-top:1px solid var(--border);flex-wrap:wrap}
.tip-lbl{font-size:.58rem;text-transform:uppercase;letter-spacing:2px;color:var(--dim);margin-bottom:.22rem}
.tip-val{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:2px}
.tv-gold{color:var(--gold)}.tv-grn{color:var(--green)}.tv-red{color:var(--red)}
.conf-block{text-align:right}
.conf-n{font-family:'Space Mono',monospace;font-size:.9rem;font-weight:700}
.conf-bar-w{width:100px;height:3px;background:var(--muted);border-radius:2px;margin-top:4px;overflow:hidden}
.conf-bar{height:100%;border-radius:2px}
.cb-hi{background:var(--green)}.cb-mid{background:var(--gold)}.cb-lo{background:var(--red)}

.odds-row{display:flex;gap:.35rem;padding:.65rem 1.2rem;border-top:1px solid var(--border)}
.obt{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:.4rem .2rem;text-align:center;cursor:pointer;transition:all .2s}
.obt:hover,.obt.sel{border-color:var(--gold);background:var(--gold-dim)}
.obt .ol{font-size:.55rem;color:var(--dim);text-transform:uppercase;letter-spacing:.5px}
.obt .on{font-family:'Space Mono',monospace;font-size:.78rem;font-weight:700;color:var(--text);margin-top:2px}

.exp-toggle{display:flex;align-items:center;justify-content:space-between;padding:.55rem 1.2rem;border-top:1px solid var(--border);cursor:pointer;transition:background .2s}
.exp-toggle:hover{background:rgba(255,255,255,.018)}
.etl{font-size:.65rem;color:var(--dim);letter-spacing:1px;text-transform:uppercase}
.earr{font-size:.65rem;color:var(--dim);transition:transform .3s}
.earr.open{transform:rotate(180deg)}

.exp-panel{display:none;background:var(--surface);border-top:1px solid var(--border);padding:1.1rem 1.2rem;animation:expIn .25s ease}
.exp-panel.open{display:block}
@keyframes expIn{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}

.xtabs{display:flex;gap:1rem;margin-bottom:1.1rem;border-bottom:1px solid var(--border);padding-bottom:.5rem}
.xtab{font-size:.65rem;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--dim);cursor:pointer;padding-bottom:.4rem;border-bottom:2px solid transparent;background:none;border-top:none;border-left:none;border-right:none;transition:all .2s}
.xtab.on{color:var(--gold);border-bottom-color:var(--gold)}

.h2h-sum{display:flex;justify-content:space-around;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:.8rem;margin-bottom:.9rem;text-align:center}
.h2sn{font-family:'Bebas Neue',sans-serif;font-size:1.7rem;line-height:1}
.h2sl{font-size:.58rem;text-transform:uppercase;letter-spacing:1px;color:var(--dim);margin-top:2px}
.h2h-bar{display:flex;height:4px;border-radius:2px;overflow:hidden;margin-bottom:1.1rem}
.match-list{display:flex;flex-direction:column;gap:.3rem}
.ml-row{display:flex;align-items:center;padding:.45rem .6rem;background:var(--card);border-radius:5px;border:1px solid var(--border);font-size:.72rem;gap:.45rem}
.ml-dt{color:var(--dim);font-size:.6rem;min-width:52px}
.ml-t{flex:1;color:var(--dim)}
.ml-sc{font-family:'Space Mono',monospace;font-weight:700;font-size:.74rem;min-width:32px;text-align:center}
.rc{width:17px;height:17px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:.55rem;font-weight:700;flex-shrink:0}
.rcH{background:var(--green-dim);color:var(--green)}.rcD{background:var(--muted);color:var(--dim)}.rcA{background:var(--red-dim);color:var(--red)}

.l5-grid{display:grid;grid-template-columns:1fr 1fr;gap:.9rem}
.l5-ttl{font-size:.6rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--dim);margin-bottom:.55rem;padding-bottom:.35rem;border-bottom:1px solid var(--border)}
.l5-row{display:flex;align-items:center;gap:.4rem;padding:.38rem .5rem;background:var(--card);border-radius:4px;border:1px solid var(--border);margin-bottom:3px;font-size:.7rem}
.l5-opp{flex:1;color:var(--dim);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;font-size:.68rem}
.l5-sc{font-family:'Space Mono',monospace;font-size:.66rem;font-weight:700}

.sbr{margin-bottom:.7rem}
.sbr-head{display:flex;justify-content:space-between;font-size:.67rem;color:var(--dim);margin-bottom:.32rem}
.sbr-track{height:4px;background:var(--muted);border-radius:2px;overflow:hidden}
.sbr-fill{height:100%;border-radius:2px;transition:width 1s ease}

.sidebar{display:flex;flex-direction:column;gap:1.3rem}
.scard{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.2rem}
.scard-title{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:3px;margin-bottom:1rem;color:var(--text)}
.mm-row{display:flex;align-items:center;gap:.7rem;margin-bottom:.7rem}
.mm-lbl{font-size:.67rem;color:var(--dim);min-width:112px}
.mm-bar{flex:1;height:3px;background:var(--muted);border-radius:2px;overflow:hidden}
.mm-fill{height:100%;border-radius:2px}
.mm-val{font-family:'Space Mono',monospace;font-size:.68rem;color:var(--text);min-width:26px;text-align:right}

.tr-row{display:flex;align-items:flex-start;gap:.6rem;padding:.5rem 0;border-bottom:1px solid var(--border)}
.tr-row:last-child{border-bottom:none}
.tr-icon{width:24px;height:24px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:.62rem;font-weight:700;flex-shrink:0}
.tiW{background:var(--green-dim);color:var(--green)}.tiL{background:var(--red-dim);color:var(--red)}
.tr-match{font-size:.72rem;line-height:1.4}.tr-tip{font-size:.62rem;color:var(--dim)}

.api-card{background:rgba(240,192,64,.04);border-color:rgba(240,192,64,.18)}
.api-stat{display:flex;align-items:center;gap:.4rem;font-size:.65rem;color:var(--dim);margin-bottom:.38rem;font-family:'Space Mono',monospace}
.api-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}

.toast{position:fixed;bottom:1.5rem;right:1.5rem;z-index:500;background:var(--card);border:1px solid var(--gold);border-radius:10px;padding:.85rem 1.1rem;max-width:280px;animation:toastIn .4s cubic-bezier(.34,1.56,.64,1) both;box-shadow:0 0 28px rgba(240,192,64,.15)}
.toast.hide{animation:toastOut .3s ease forwards}
@keyframes toastIn{from{opacity:0;transform:translateX(50px)}to{opacity:1;transform:translateX(0)}}
@keyframes toastOut{to{opacity:0;transform:translateX(50px)}}
.toast-ttl{font-weight:700;font-size:.78rem;color:var(--gold);margin-bottom:.22rem}
.toast-body{font-size:.7rem;color:var(--dim);line-height:1.5}

.error-box{background:var(--red-dim);border:1px solid rgba(255,68,85,.25);border-radius:8px;padding:1.2rem;font-size:.78rem;color:var(--red);text-align:center;line-height:1.8}
.empty-box{text-align:center;padding:3rem;color:var(--dim);font-size:.82rem;line-height:1.8}
</style>
</head>
<body>

<nav>
  <div class="logo" onclick="scrollTo(0,0)">PROPRED</div>
  <div class="nav-right">
    <button class="nav-link" onclick="document.getElementById('predictions').scrollIntoView({behavior:'smooth'})">Predictions</button>
    <button class="nav-link" onclick="document.getElementById('how').scrollIntoView({behavior:'smooth'})">How It Works</button>
    <div class="nav-pill pill-date">
      <span>üìÖ</span>
      <input type="date" id="globalDate" onchange="loadDate(this.value)">
    </div>
    <div class="nav-pill pill-live" id="apiPill">
      <div class="pdot"></div>
      <span id="apiPillTxt">LOADING‚Ä¶</span>
    </div>
  </div>
</nav>

<div class="ticker">
  <div class="ticker-track">
    <div class="ticker-item">‚öΩ PROPRED ‚Äî AI FOOTBALL INTELLIGENCE</div>
    <div class="ticker-item">üíé VALUE TIPS = REAL EDGE OVER THE MARKET</div>
    <div class="ticker-item">üõ° SAFE TIPS FOR RISK-AVERSE BETTORS</div>
    <div class="ticker-item">üö´ AVOID BADGE = HIGH VARIANCE DETECTED</div>
    <div class="ticker-item">‚≠ê RELIABLE = STRONG H2H PATTERNS</div>
    <div class="ticker-item">üì° POWERED BY SPORTMONKS LIVE DATA</div>
    <div class="ticker-item">‚öΩ PROPRED ‚Äî AI FOOTBALL INTELLIGENCE</div>
    <div class="ticker-item">üíé VALUE TIPS = REAL EDGE OVER THE MARKET</div>
    <div class="ticker-item">üõ° SAFE TIPS FOR RISK-AVERSE BETTORS</div>
    <div class="ticker-item">üö´ AVOID BADGE = HIGH VARIANCE DETECTED</div>
    <div class="ticker-item">‚≠ê RELIABLE = STRONG H2H PATTERNS</div>
    <div class="ticker-item">üì° POWERED BY SPORTMONKS LIVE DATA</div>
  </div>
</div>

<section class="hero" id="top">
  <div class="hero-grid"></div>
  <div style="position:relative;z-index:1">
    <div class="hero-eyebrow">‚ö° Real Data ¬∑ Real Intelligence ¬∑ Real Edge</div>
    <h1>PREDICT<br><em>SMARTER</em></h1>
    <p>PROPRED analyses every fixture with live Sportmonks data ‚Äî form, H2H, scoring trends ‚Äî then classifies every tip with a badge so you always know when to bet and when to walk away.</p>
    <div class="hero-btns">
      <button class="btn btn-gold" onclick="document.getElementById('predictions').scrollIntoView({behavior:'smooth'})">View Today's Picks</button>
      <button class="btn btn-outline" onclick="document.getElementById('how').scrollIntoView({behavior:'smooth'})">How It Works</button>
    </div>
  </div>
</section>

<div class="stats-bar">
  <div class="stat-item" id="statOverall"><div class="stat-n">‚Äî</div><div class="stat-l">Overall Accuracy</div></div>
  <div class="stat-item" id="statValue"><div class="stat-n">‚Äî</div><div class="stat-l">Value Tip Rate</div></div>
  <div class="stat-item" id="statSafe"><div class="stat-n">‚Äî</div><div class="stat-l">Safe Tip Rate</div></div>
  <div class="stat-item" id="fixtureCountStat"><div class="stat-n">‚Äî</div><div class="stat-l">Fixtures Today</div></div>
  <div class="stat-item" id="statResolved"><div class="stat-n">‚Äî</div><div class="stat-l">Tips Tracked</div></div>
</div>

<div class="main-wrap" id="predictions">
  <div>
    <div class="sec-head">
      <div class="sec-title">Today's Fixtures</div>
      <div class="sec-meta" id="dateLabel">‚Äî</div>
    </div>
    <div class="date-bar" id="dateBar"></div>
    <div class="ai-banner" id="aiBanner">
      <div class="ai-dots"><span></span><span></span><span></span></div>
      <span id="aiBannerTxt">Connecting to Sportmonks‚Ä¶</span>
    </div>
    <div class="filter-row" id="filterRow" style="display:none">
      <button class="ftab on" onclick="applyFilter('all',this)">All</button>
      <button class="ftab" onclick="applyFilter('val',this)">üíé Value</button>
      <button class="ftab" onclick="applyFilter('safe',this)">üõ° Safe</button>
      <button class="ftab" onclick="applyFilter('reliable',this)">‚≠ê Reliable</button>
      <button class="ftab" onclick="applyFilter('avoid',this)">‚ö†Ô∏è Risky</button>
      <button class="ftab" id="sortBtn" onclick="toggleSort(this)" style="margin-left:auto">‚Üï Confidence</button>
    </div>
    <div id="predsContainer"></div>
  </div>

  <div class="sidebar">
    <div class="scard">
      <div class="scard-title">üß† Model Brain</div>
      <div id="modelBrainRows">
        <div class="mm-row"><div class="mm-lbl">Overall Accuracy</div><div class="mm-bar"><div class="mm-fill" id="mb-overall" style="width:0%;background:var(--green)"></div></div><div class="mm-val" id="mbv-overall">‚Äî</div></div>
        <div class="mm-row"><div class="mm-lbl">Value Tips</div><div class="mm-bar"><div class="mm-fill" id="mb-val" style="width:0%;background:var(--gold)"></div></div><div class="mm-val" id="mbv-val">‚Äî</div></div>
        <div class="mm-row"><div class="mm-lbl">Safe Tips</div><div class="mm-bar"><div class="mm-fill" id="mb-safe" style="width:0%;background:var(--green)"></div></div><div class="mm-val" id="mbv-safe">‚Äî</div></div>
        <div class="mm-row"><div class="mm-lbl">Reliable Tips</div><div class="mm-bar"><div class="mm-fill" id="mb-reliable" style="width:0%;background:var(--blue)"></div></div><div class="mm-val" id="mbv-reliable">‚Äî</div></div>
        <div class="mm-row"><div class="mm-lbl">Teams Tracked</div><div class="mm-bar"><div class="mm-fill" id="mb-teams" style="width:0%;background:var(--purple)"></div></div><div class="mm-val" id="mbv-teams">‚Äî</div></div>
      </div>
      <div style="margin-top:.9rem;padding-top:.9rem;border-top:1px solid var(--border)">
        <div style="font-size:.58rem;color:var(--dim);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:.35rem">Last Updated</div>
        <div style="font-family:'Space Mono',monospace;font-size:.74rem" id="lastUpdated">‚Äî</div>
      </div>
    </div>

    <div class="scard" id="trackRecordCard">
      <div class="scard-title">üìà Track Record <span id="trLive" style="font-size:.6rem;color:var(--green);font-family:'Space Mono',monospace;font-weight:normal"></span></div>
      <div id="trackRecordRows">
        <div style="color:var(--dim);font-size:.72rem;text-align:center;padding:1rem 0">Loading track record‚Ä¶</div>
      </div>
    </div>

    <div class="scard api-card">
      <div class="scard-title" style="color:var(--gold);font-size:.9rem">‚ö° Live Data Sources</div>
      <div class="api-stat"><div class="api-dot" id="d1" style="background:var(--green)"></div>Sportmonks Fixtures</div>
      <div class="api-stat"><div class="api-dot" id="d2" style="background:var(--green)"></div>H2H Match History</div>
      <div class="api-stat"><div class="api-dot" id="d3" style="background:var(--green)"></div>Team Form Tracker</div>
      <div class="api-stat"><div class="api-dot" id="d4" style="background:var(--purple)"></div>Team Memory DB</div>
      <div class="api-stat"><div class="api-dot" id="d5" style="background:var(--gold)"></div>Prediction Tracker</div>
    </div>
  </div>
</div>

<div id="how" style="max-width:1380px;margin:0 auto;padding:2rem 1.5rem 5rem">
  <div class="sec-head"><div class="sec-title">How The Model Works</div></div>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem">
    <div class="scard" style="text-align:center"><div style="font-size:1.8rem;margin-bottom:.7rem">üì°</div><div style="font-weight:700;margin-bottom:.4rem;font-size:.9rem">Live Data Fetch</div><div style="font-size:.75rem;color:var(--dim);line-height:1.7">Real fixtures, form, H2H and scores pulled from Sportmonks every load.</div></div>
    <div class="scard" style="text-align:center"><div style="font-size:1.8rem;margin-bottom:.7rem">üß†</div><div style="font-weight:700;margin-bottom:.4rem;font-size:.9rem">Form Scoring</div><div style="font-size:.75rem;color:var(--dim);line-height:1.7">Every team gets a form score from last 5 results, weighted for home/away.</div></div>
    <div class="scard" style="text-align:center"><div style="font-size:1.8rem;margin-bottom:.7rem">üíé</div><div style="font-weight:700;margin-bottom:.4rem;font-size:.9rem">Value Detection</div><div style="font-size:.75rem;color:var(--dim);line-height:1.7">Model probability vs implied odds ‚Äî 8%+ gap triggers the üíé VALUE badge.</div></div>
    <div class="scard" style="text-align:center"><div style="font-size:1.8rem;margin-bottom:.7rem">üö´</div><div style="font-weight:700;margin-bottom:.4rem;font-size:.9rem">Avoid Signals</div><div style="font-size:.75rem;color:var(--dim);line-height:1.7">High variance or low confidence = AVOID badge. Protects your bankroll.</div></div>
  </div>
</div>

<div class="toast" id="toast" style="display:none">
  <div class="toast-ttl" id="toastTitle">‚Äî</div>
  <div class="toast-body" id="toastBody">‚Äî</div>
</div>

<script>
// ‚îÄ‚îÄ All API calls go through our own /api/ proxy ‚îÄ‚îÄ
const BASE = '/api';
let currentFilter = 'all';

function todayISO() { return new Date().toISOString().split('T')[0]; }
function fmtDate(d) { return new Date(d).toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short',year:'numeric'}); }

function showToast(title,body,dur=5000){
  const t=document.getElementById('toast');
  t.style.display='block';t.classList.remove('hide');
  document.getElementById('toastTitle').textContent=title;
  document.getElementById('toastBody').textContent=body;
  setTimeout(()=>{t.classList.add('hide');setTimeout(()=>t.style.display='none',350);},dur);
}

function setPill(txt,ok=true){
  const p=document.getElementById('apiPill');
  document.getElementById('apiPillTxt').textContent=txt;
  p.className='nav-pill '+(ok?'pill-live':'pill-error');
}

function buildDateBar(sel){
  const bar=document.getElementById('dateBar');bar.innerHTML='';
  const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  for(let i=-2;i<=4;i++){
    const d=new Date();d.setDate(d.getDate()+i);
    const iso=d.toISOString().split('T')[0];
    const c=document.createElement('div');
    c.className='date-chip'+(iso===sel?' active':'');
    c.innerHTML=`<span class="date-chip-day">${days[d.getDay()]}</span><span class="date-chip-num">${d.getDate()}</span>`;
    c.onclick=()=>loadDate(iso);
    bar.appendChild(c);
  }
}

async function api(endpoint){
  const r=await fetch(`${BASE}${endpoint}`);
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

function getGoals(scores,side){
  return scores?.find(s=>s.description==='CURRENT'&&s.score?.participant===side)?.score?.goals??null;
}

function getForm(fixtures,teamId){
  const sorted=[...fixtures].sort((a,b)=>new Date(b.starting_at)-new Date(a.starting_at));
  const form=[],raw=[];
  for(const f of sorted){
    if(form.length>=5)break;
    const hG=getGoals(f.scores,'home'),aG=getGoals(f.scores,'away');
    if(hG===null||aG===null)continue;
    const isH=f.participants?.find(p=>p.meta?.location==='home')?.id===teamId;
    const my=isH?hG:aG,their=isH?aG:hG;
    form.push(my>their?'W':my<their?'L':'D');
    raw.push(f);
  }
  return{dots:form.reverse(),fixtures:raw.reverse()};
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DEEP STATS ENGINE v3 ‚Äî recency-weighted, home/away split, momentum, Poisson
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Poisson probability: P(X=k) = e^-Œª * Œª^k / k!
function poisson(lambda, k){
  let p=Math.exp(-lambda);
  for(let i=1;i<=k;i++) p*=lambda/i;
  return p;
}

// P(total goals > threshold) using Poisson for both teams
function poissonOver(hLambda, aLambda, threshold){
  let prob=0;
  for(let h=0;h<=8;h++) for(let a=0;a<=8;a++)
    if(h+a>threshold) prob+=poisson(hLambda,h)*poisson(aLambda,a);
  return prob;
}

// P(BTTS) using Poisson
function poissonBTTS(hLambda, aLambda){
  const hScores = 1-poisson(hLambda,0);
  const aScores = 1-poisson(aLambda,0);
  return hScores*aScores;
}

// P(home win), P(draw), P(away win) via Poisson scoreline matrix
function poissonResult(hLambda, aLambda){
  let hw=0,d=0,aw=0;
  for(let h=0;h<=8;h++) for(let a=0;a<=8;a++){
    const p=poisson(hLambda,h)*poisson(aLambda,a);
    if(h>a)hw+=p; else if(h===a)d+=p; else aw+=p;
  }
  return{hw,d,aw};
}

// Rich per-team stats with home/away split + recency weighting + momentum
function getTeamStats(fixtures, teamId){
  const completed = [...fixtures]
    .sort((a,b)=>new Date(b.starting_at)-new Date(a.starting_at))
    .filter(f=>getGoals(f.scores,'home')!==null&&getGoals(f.scores,'away')!==null);
  if(!completed.length) return null;

  // All stats (overall)
  let scored=0,conceded=0,cleanSheets=0,failedToScore=0,
      over25=0,btts=0,wins=0,draws=0,losses=0,matches=0;
  // Home/Away split
  let hScored=0,hConceded=0,hMatches=0,hWins=0;
  let aScored=0,aConceded=0,aMatches=0,aWins=0;
  // Recency-weighted scored/conceded (last 5 get 2x weight)
  let wScored=0,wConceded=0,wTotal=0;
  // Scoring streak (consecutive matches scored)
  let scoringStreak=0,streakCounting=true;
  // Momentum: last 3 vs previous 3 win rate
  const recentPts=[],olderPts=[];

  completed.forEach((f,i)=>{
    const isH = f.participants?.find(p=>p.meta?.location==='home')?.id===teamId;
    const myG = isH?getGoals(f.scores,'home'):getGoals(f.scores,'away');
    const thG = isH?getGoals(f.scores,'away'):getGoals(f.scores,'home');
    const w = i<5 ? 2 : 1; // recency weight

    scored+=myG; conceded+=thG; matches++;
    wScored+=myG*w; wConceded+=thG*w; wTotal+=w;
    if(thG===0) cleanSheets++;
    if(myG===0) failedToScore++;
    if(myG+thG>2.5) over25++;
    if(myG>0&&thG>0) btts++;
    if(myG>thG){wins++;if(i<3)recentPts.push(3);else if(i<6)olderPts.push(3);}
    else if(myG===thG){draws++;if(i<3)recentPts.push(1);else if(i<6)olderPts.push(1);}
    else{losses++;if(i<3)recentPts.push(0);else if(i<6)olderPts.push(0);}

    if(isH){hScored+=myG;hConceded+=thG;hMatches++;if(myG>thG)hWins++;}
    else{aScored+=myG;aConceded+=thG;aMatches++;if(myG>thG)aWins++;}

    // Scoring streak (most recent first)
    if(streakCounting){
      if(myG>0) scoringStreak++;
      else streakCounting=false;
    }
  });

  // Momentum: +ve = improving, -ve = declining
  const recentAvg = recentPts.length ? recentPts.reduce((a,b)=>a+b,0)/recentPts.length : 1;
  const olderAvg  = olderPts.length  ? olderPts.reduce((a,b)=>a+b,0)/olderPts.length   : 1;
  const momentum  = recentAvg - olderAvg; // range ~[-3,+3]

  return{
    matches,
    avgScored:    scored/matches,
    avgConceded:  conceded/matches,
    // Recency-weighted (better for Œª estimate)
    wAvgScored:   wTotal ? wScored/wTotal : scored/matches,
    wAvgConceded: wTotal ? wConceded/wTotal : conceded/matches,
    csRate:       cleanSheets/matches,
    ftsRate:      failedToScore/matches,
    over25Rate:   over25/matches,
    bttsRate:     btts/matches,
    winRate:      wins/matches,
    drawRate:     draws/matches,
    lossRate:     losses/matches,
    // Home split
    homeAvgScored:   hMatches ? hScored/hMatches   : null,
    homeAvgConceded: hMatches ? hConceded/hMatches : null,
    homeWinRate:     hMatches ? hWins/hMatches      : null,
    // Away split
    awayAvgScored:   aMatches ? aScored/aMatches   : null,
    awayAvgConceded: aMatches ? aConceded/aMatches : null,
    awayWinRate:     aMatches ? aWins/aMatches      : null,
    // Momentum & streak
    momentum,
    scoringStreak,
  };
}

// ‚îÄ‚îÄ MAIN MODEL v3 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runModel(fixture, h2h, homeFm, awayFm){
  const homeT = fixture.participants?.find(p=>p.meta?.location==='home');
  const awayT = fixture.participants?.find(p=>p.meta?.location==='away');

  // Form scores (recency-weighted W=3,D=1,L=0)
  const fs=(dots,isHome)=>{
    if(!dots?.length) return isHome?0.44:0.38;
    const weights=[3,3,2,2,1]; // last game most important
    let pts=0,wt=0;
    dots.slice().reverse().forEach((r,i)=>{
      const w=weights[i]||1;
      pts+=(r==='W'?3:r==='D'?1:0)*w; wt+=3*w;
    });
    return pts/wt;
  };
  const hFS=fs(homeFm.dots,true), aFS=fs(awayFm.dots,false);

  // Use blended stats (memory-enriched) if available, else compute fresh
  const hSt = homeFm.blendedStats !== undefined ? homeFm.blendedStats : getTeamStats(homeFm.fixtures, homeT?.id);
  const aSt = awayFm.blendedStats !== undefined ? awayFm.blendedStats : getTeamStats(awayFm.fixtures, awayT?.id);

  // H2H record
  let hW=0,dW=0,aW=0;
  (h2h||[]).slice(0,10).forEach(m=>{
    const hG=getGoals(m.scores,'home'),aG=getGoals(m.scores,'away');
    if(hG===null||aG===null)return;
    const isOurHome=m.participants?.find(p=>p.meta?.location==='home')?.id===homeT?.id;
    if(hG>aG)isOurHome?hW++:aW++;
    else if(aG>hG)isOurHome?aW++:hW++;
    else dW++;
  });
  const tot=hW+dW+aW||1;
  const h2hHomeRate=hW/tot, h2hDrawRate=dW/tot, h2hAwayRate=aW/tot;

  const h2hCompleted=(h2h||[]).filter(m=>getGoals(m.scores,'home')!==null);
  const h2hAvgGoals = h2hCompleted.length
    ? h2hCompleted.reduce((a,m)=>(a+(getGoals(m.scores,'home')??0)+(getGoals(m.scores,'away')??0)),0)/h2hCompleted.length
    : null;
  const h2hBtts = h2hCompleted.length
    ? h2hCompleted.filter(m=>(getGoals(m.scores,'home')??0)>0&&(getGoals(m.scores,'away')??0)>0).length/h2hCompleted.length
    : null;

  // ‚îÄ‚îÄ POISSON Œª ‚Äî Dixon-Coles multiplicative ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Œª = attackStrength √ó defenceWeakness √ó leagueAvg
  // This properly amplifies good attacks vs bad defences
  // rather than pulling everything toward the league average
  const leagueAvg = 1.35;

  // Use home-specific stats where available (home/away splits matter a lot)
  const hScoringAvg  = hSt ? (hSt.homeAvgScored   ?? hSt.wAvgScored)   : leagueAvg;
  const hConcAvg     = hSt ? (hSt.homeAvgConceded  ?? hSt.wAvgConceded) : leagueAvg;
  const aScoringAvg  = aSt ? (aSt.awayAvgScored    ?? aSt.wAvgScored)   : leagueAvg;
  const aConcAvg     = aSt ? (aSt.awayAvgConceded  ?? aSt.wAvgConceded) : leagueAvg;

  // Attack & defence strengths relative to league average
  const hAttackStr = hScoringAvg / leagueAvg;   // >1 = strong attack
  const hDefStr    = hConcAvg    / leagueAvg;   // >1 = leaky defence
  const aAttackStr = aScoringAvg / leagueAvg;
  const aDefStr    = aConcAvg    / leagueAvg;

  // Expected goals per team this match (Dixon-Coles)
  // hLambda = home attack strength √ó away defence weakness √ó league avg
  // Clamp to [0.4, 3.5] to avoid Poisson edge cases
  const hLambda = Math.min(Math.max(hAttackStr * aDefStr * leagueAvg, 0.4), 3.5);
  const aLambda = Math.min(Math.max(aAttackStr * hDefStr * leagueAvg, 0.4), 3.5);

  // Poisson probabilities
  const pResult  = poissonResult(hLambda, aLambda);
  const pOver25  = poissonOver(hLambda, aLambda, 2.5);
  const pOver15  = poissonOver(hLambda, aLambda, 1.5);
  const pOver35  = poissonOver(hLambda, aLambda, 3.5);
  const pBTTS    = poissonBTTS(hLambda, aLambda);
  const expectedGoals = hLambda + aLambda;

  // ‚îÄ‚îÄ BLEND POISSON WITH HISTORICAL SIGNALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Note: pResult.hw for even match is ~0.37, strong home ~0.55+
  // All thresholds must reflect real football probability ranges
  const homeResultScore = pResult.hw*0.5 + h2hHomeRate*0.2 + (hSt?.winRate||0.35)*0.2 + hFS*0.1;
  const awayResultScore = pResult.aw*0.5 + h2hAwayRate*0.2 + (aSt?.winRate||0.30)*0.2 + aFS*0.1;
  const drawScore       = pResult.d*0.5  + h2hDrawRate*0.25 + (hSt?.drawRate||0.22)*0.125 + (aSt?.drawRate||0.22)*0.125;

  const over25Signal = pOver25*0.45 + (hSt?.over25Rate??0.48)*0.2 + (aSt?.over25Rate??0.48)*0.2
                     + (h2hAvgGoals!==null?(h2hAvgGoals>2.5?0.12:h2hAvgGoals<2?-0.05:0.04):0.05)
                     + (expectedGoals>2.8?0.08:0);
  const under25Signal= (1-pOver25)*0.45 + (hSt?.csRate??0.22)*0.2 + (aSt?.csRate??0.22)*0.15
                     + (h2hAvgGoals!==null?(h2hAvgGoals<2?0.15:0):0.05);
  const bttsSignal   = pBTTS*0.45 + (hSt?.bttsRate??0.48)*0.2 + (aSt?.bttsRate??0.48)*0.2
                     + (h2hBtts!==null?h2hBtts*0.1:0.05)
                     + (hLambda>1.3&&aLambda>1.0?0.05:0);
  const nbttsSignal  = (1-pBTTS)*0.45 + (hSt?.csRate??0.25)*0.25 + (aSt?.ftsRate??0.2)*0.2
                     + (h2hBtts!==null?(1-h2hBtts)*0.1:0.05);

  // ‚îÄ‚îÄ MOMENTUM ADJUSTMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const hMom = hSt?.momentum ?? 0;
  const aMom = aSt?.momentum ?? 0;
  const homeBoost = hMom*0.025 - aMom*0.01;
  const awayBoost = aMom*0.025 - hMom*0.01;

  const adjHomeScore = Math.min(homeResultScore + homeBoost, 0.92);
  const adjAwayScore = Math.min(awayResultScore + awayBoost, 0.88);

  // ‚îÄ‚îÄ CANDIDATE TIPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Thresholds calibrated to real football:
  // - Even match: homeWin ~0.37, awayWin ~0.33, draw ~0.28
  // - Clear home favourite: homeWin ~0.52-0.62
  // - Strong home: homeWin ~0.62+
  const candidates = [];
  const hName=homeT?.name||'Home', aName=awayT?.name||'Away';
  const hS=hName.split(' ').slice(-1)[0], aS=aName.split(' ').slice(-1)[0];

  // Result tips ‚Äî thresholds relative to actual Poisson ranges
  if(adjHomeScore>0.40)   // home is even slight favourite
    candidates.push({tip:`${hName} Win`,safe:`${hS} Draw No Bet`,score:adjHomeScore,type:'result'});
  if(adjHomeScore>0.36&&drawScore>0.20)
    candidates.push({tip:`${hName} Win or Draw`,safe:`${hS} Double Chance`,score:(adjHomeScore+drawScore)*0.62,type:'result'});
  if(adjAwayScore>0.35)   // away team has genuine chance
    candidates.push({tip:`${aName} Win`,safe:`${aS} Draw No Bet`,score:adjAwayScore,type:'result'});
  if(adjAwayScore>0.32&&drawScore>0.22)
    candidates.push({tip:`${aName} Win or Draw`,safe:`${aS} Double Chance`,score:(adjAwayScore+drawScore)*0.60,type:'result'});
  if(drawScore>0.28)
    candidates.push({tip:'Draw',safe:'Both Teams To Score',score:drawScore,type:'draw'});

  // AH when clearly dominant (home win > 0.52 = real favourite)
  if(adjHomeScore>0.52)
    candidates.push({tip:`${hS} -0.5 Asian Handicap`,safe:`${hName} Win`,score:adjHomeScore*0.93,type:'ah'});
  if(adjAwayScore>0.47)
    candidates.push({tip:`${aS} -0.5 Asian Handicap`,safe:`${aName} Win`,score:adjAwayScore*0.90,type:'ah'});

  // Combo (result + goals)
  if(adjHomeScore>0.42&&bttsSignal>0.48)
    candidates.push({tip:`${hName} Win & BTTS`,safe:`${hName} Win`,score:(adjHomeScore*0.55+bttsSignal*0.45),type:'combo'});
  if(adjHomeScore>0.44&&over25Signal>0.50)
    candidates.push({tip:`${hName} Win & Over 2.5`,safe:`Over 2.5 Goals`,score:(adjHomeScore*0.5+over25Signal*0.5),type:'combo'});
  if(adjAwayScore>0.38&&bttsSignal>0.50)
    candidates.push({tip:`${aName} Win & BTTS`,safe:`${aName} Win`,score:(adjAwayScore*0.55+bttsSignal*0.45),type:'combo'});

  // Goals markets
  if(over25Signal>0.45)
    candidates.push({tip:'Over 2.5 Goals',safe:'Over 1.5 Goals',score:over25Signal,type:'goals'});
  if(over25Signal>0.60)
    candidates.push({tip:'Over 3.5 Goals',safe:'Over 2.5 Goals',score:over25Signal*0.78,type:'goals'});
  if(under25Signal>0.52&&over25Signal<0.38)
    candidates.push({tip:'Under 2.5 Goals',safe:'Under 3.5 Goals',score:under25Signal,type:'goals'});
  if(bttsSignal>0.50)
    candidates.push({tip:'Both Teams To Score',safe:'Over 1.5 Goals',score:bttsSignal,type:'goals'});
  if(nbttsSignal>0.55&&bttsSignal<0.40)
    candidates.push({tip:'No ‚Äî BTTS',safe:`${hS} Clean Sheet`,score:nbttsSignal,type:'goals'});

  // Scoring streak bonus
  if(hSt?.scoringStreak>=4)
    candidates.push({tip:`${hName} To Score`,safe:`${hName} Win or Draw`,score:0.78,type:'goals'});
  if(aSt?.scoringStreak>=4)
    candidates.push({tip:`${aName} To Score`,safe:'Both Teams To Score',score:0.74,type:'goals'});

  // Over 1.5 only as true last resort
  candidates.push({tip:'Over 1.5 Goals',safe:`${hS} Double Chance`,score:pOver15*0.55,type:'goals'});

  candidates.sort((a,b)=>b.score-a.score);
  const best     = candidates[0];
  const safeCand = candidates.find(c=>c.tip!==best.tip&&c.type!==best.type)||candidates[1];
  const mainTip  = best.tip;
  const safeTip  = safeCand?.safe||best.safe||'Over 1.5 Goals';

  // ‚îÄ‚îÄ CONFIDENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // More data = higher ceiling. Poisson agreement with historical = bonus.
  const dataMatches  = Math.min((hSt?.matches||0)+(aSt?.matches||0), 30);
  const dataCeiling  = 70 + Math.round(dataMatches/30*22); // 70-92 ceiling
  const h2hBonus     = tot>=6?5:tot>=3?2:0;
  const momentumBonus= Math.round((hMom-aMom)*1.5);
  let conf = Math.round(best.score*95 + h2hBonus + momentumBonus);
  conf = Math.max(42, Math.min(conf, dataCeiling));

  // ‚îÄ‚îÄ BADGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let tipType,badgeClass,badges=[];
  if(best.score>0.70){
    tipType='val';badgeClass='val';badges=['üíé VALUE'];
    if(best.score>0.80)badges.unshift('üî• HOT');
    if((h2hHomeRate>0.6||h2hAwayRate>0.6)&&tot>=4)badges.push('‚≠ê RELIABLE');
  }else if(best.score>0.58){
    tipType='safe';badgeClass='safe';badges=['üõ° SAFE'];
    if(tot>=4&&(h2hHomeRate>0.55||h2hDrawRate>0.32))badges.push('‚≠ê RELIABLE');
  }else if(best.score>0.50){
    tipType='reliable';badgeClass='reliable';badges=['‚≠ê RELIABLE'];
  }else{
    tipType='safe';badgeClass='safe';badges=['üõ° SAFE'];
  }

  const isHighVariance=(!hSt&&!aSt&&tot<2);
  if(isHighVariance){badges.push('‚ö†Ô∏è RISKY');conf=Math.max(conf-10,38);}

  return{
    tipType,main:mainTip,safe:safeTip,conf,badgeClass,badges,
    hW,dW,aW,tot,hFS,aFS,hSt,aSt,
    hLambda,aLambda,expectedGoals,
    pResult,pOver25,pBTTS,
    over25Signal,bttsSignal,under25Signal,h2hAvgGoals,
    homeResultScore:adjHomeScore,awayResultScore:adjAwayScore,drawScore,
    hMom,aMom,isHighVariance,
    confClass:conf>74?'cb-hi':conf>54?'cb-mid':'cb-lo'
  };
}

// ‚îÄ‚îÄ INSIGHT TEXT v3 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildInsight(m, homeN, awayN){
  const lines=[];

  // Attacking output
  if(m.hSt&&m.aSt){
    const hAvg=m.hSt.wAvgScored.toFixed(1),aAvg=m.aSt.wAvgScored.toFixed(1);
    const hConc=m.hSt.wAvgConceded.toFixed(1),aConc=m.aSt.wAvgConceded.toFixed(1);
    lines.push(`${homeN} avg ${hAvg} scored, ${hConc} conceded per game. ${awayN} avg ${aAvg} scored, ${aConc} conceded.`);
  } else {
    lines.push(m.hFS>0.6?`${homeN} in strong form.`:m.aFS>0.6?`${awayN} in strong form.`:`Form is balanced ‚Äî leaning on Poisson model.`);
  }

  // Poisson xG
  lines.push(`Expected goals: ${m.hLambda.toFixed(2)} (${homeN}) vs ${m.aLambda.toFixed(2)} (${awayN}) = ${m.expectedGoals.toFixed(1)} total. P(Over 2.5)=${Math.round(m.pOver25*100)}%, P(BTTS)=${Math.round(m.pBTTS*100)}%.`);

  // H2H
  if(m.tot>=3){
    let l=`H2H last ${m.tot}: ${homeN} ${m.hW}W‚Äì${m.dW}D‚Äì${m.aW}L.`;
    if(m.h2hAvgGoals!==null)l+=` Avg ${m.h2hAvgGoals.toFixed(1)} goals/game.`;
    lines.push(l);
  } else {
    lines.push(`Limited H2H (${m.tot}) ‚Äî Poisson model weighted more heavily.`);
  }

  // Momentum
  if(m.hMom>0.8) lines.push(`üìà ${homeN} momentum improving (last 3 > previous 3).`);
  if(m.aMom>0.8) lines.push(`üìà ${awayN} momentum improving.`);
  if(m.hMom<-0.8) lines.push(`üìâ ${homeN} form declining recently.`);
  if(m.aMom<-0.8) lines.push(`üìâ ${awayN} form declining recently.`);

  // Streak
  if(m.hSt?.scoringStreak>=4) lines.push(`üî• ${homeN} scored in last ${m.hSt.scoringStreak} straight.`);
  if(m.aSt?.scoringStreak>=4) lines.push(`üî• ${awayN} scored in last ${m.aSt.scoringStreak} straight.`);

  // Clean sheets
  if(m.hSt?.csRate>0.4) lines.push(`${homeN} keeping clean sheets ${Math.round(m.hSt.csRate*100)}% of games.`);
  if(m.aSt?.csRate>0.4) lines.push(`${awayN} keeping clean sheets ${Math.round(m.aSt.csRate*100)}% of games.`);

  if(m.isHighVariance) lines.push(`‚ö†Ô∏è Limited data ‚Äî smaller stake advised.`);

  return lines.join(' ');
}

// ‚îÄ‚îÄ LEARNING SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let calibrationData = null;

// Load calibration + track record on page start
async function loadLearningData() {
  try {
    const [calibResp, resultsResp, healthResp] = await Promise.all([
      fetch('/calibration').then(r=>r.json()).catch(()=>null),
      fetch('/predictions/results?limit=15').then(r=>r.json()).catch(()=>[]),
      fetch('/health').then(r=>r.json()).catch(()=>null),
    ]);

    calibrationData = calibResp;

    // Update stats bar
    if(calibResp?.overall?.rate!=null){
      document.getElementById('statOverall').querySelector('.stat-n').textContent = calibResp.overall.rate+'%';
    }
    if(calibResp?.byType?.val?.rate!=null){
      document.getElementById('statValue').querySelector('.stat-n').textContent = calibResp.byType.val.rate+'%';
    }
    if(calibResp?.byType?.safe?.rate!=null){
      document.getElementById('statSafe').querySelector('.stat-n').textContent = calibResp.byType.safe.rate+'%';
    }
    if(calibResp?.overall?.total!=null){
      document.getElementById('statResolved').querySelector('.stat-n').textContent = calibResp.overall.total;
    }

    // Update Model Brain sidebar
    const setBar=(id,val,max=100)=>{
      const pct=Math.min(Math.round(val/max*100),100);
      const fill=document.getElementById('mb-'+id);
      const valEl=document.getElementById('mbv-'+id);
      if(fill) fill.style.width=pct+'%';
      if(valEl) valEl.textContent=(typeof val==='number'&&!isNaN(val))?val+(id==='teams'?'':'%'):'‚Äî';
    };

    if(calibResp?.overall?.rate!=null) setBar('overall', calibResp.overall.rate);
    if(calibResp?.byType?.val?.rate!=null) setBar('val', calibResp.byType.val.rate);
    if(calibResp?.byType?.safe?.rate!=null) setBar('safe', calibResp.byType.safe.rate);
    if(calibResp?.byType?.reliable?.rate!=null) setBar('reliable', calibResp.byType.reliable.rate);
    if(healthResp?.teams!=null) setBar('teams', Math.min(healthResp.teams, 500), 500);

    // Update Track Record sidebar with real results
    const trRows = document.getElementById('trackRecordRows');
    const trLive = document.getElementById('trLive');
    if(resultsResp?.length){
      if(trLive) trLive.textContent = `(${resultsResp.length} tracked)`;
      trRows.innerHTML = resultsResp.slice(0,8).map(p=>{
        const icon = p.result==='win'?'tiW':p.result==='loss'?'tiL':'tiP';
        const sym  = p.result==='win'?'‚úì':p.result==='loss'?'‚úó':'~';
        const score= p.homeGoals!=null?` ¬∑ ${p.homeGoals}‚Äì${p.awayGoals}`:'';
        return `<div class="tr-row">
          <div class="tr-icon ${icon}">${sym}</div>
          <div>
            <div class="tr-match">${p.homeTeam||'?'} vs ${p.awayTeam||'?'}${score}</div>
            <div class="tr-tip">${p.tip} ¬∑ ${p.conf}% conf</div>
          </div>
        </div>`;
      }).join('');
    } else {
      trRows.innerHTML = `<div style="color:var(--dim);font-size:.72rem;text-align:center;padding:1rem 0">No results yet ‚Äî predictions save automatically and resolve after each match.</div>`;
    }

  } catch(e) {
    console.log('[LEARNING] Could not load calibration:', e.message);
  }
}

// Save a prediction to the server
async function savePrediction(fixture, model, homeTeam, awayTeam) {
  try {
    await fetch('/predictions/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        fixtureId:  fixture.id,
        date:       fixture.starting_at?.split('T')[0],
        homeTeam:   homeTeam?.name || 'Home',
        awayTeam:   awayTeam?.name || 'Away',
        homeTeamId: homeTeam?.id,
        awayTeamId: awayTeam?.id,
        league:     fixture.league?.name || '',
        tip:        model.main,
        tipType:    model.tipType,
        safeTip:    model.safe,
        conf:       model.conf,
        hLambda:    model.hLambda,
        aLambda:    model.aLambda,
        pResult:    model.pResult,
        pOver25:    model.pOver25,
        pBTTS:      model.pBTTS,
      })
    });
  } catch(e) {
    // Silently fail ‚Äî prediction saving is non-critical
  }
}

// Save team memory to server
async function saveTeamMemory(teamId, stats) {
  try {
    await fetch('/memory/team', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ teamId, stats })
    });
  } catch(e) {}
}

// Get calibration-adjusted confidence
// If our 70-80% tips are actually hitting 85%, adjust upward (and vice versa)
function getCalibratedConf(rawConf, tipType) {
  if(!calibrationData?.buckets) return rawConf;
  const bucket = Math.floor(rawConf / 10) * 10;
  const b = calibrationData.buckets[bucket];
  if(!b || b.total < 5) return rawConf; // need at least 5 samples to calibrate
  // Apply half the error as correction (don't overcorrect)
  const adjustment = Math.round(b.error * 0.5);
  return Math.max(40, Math.min(rawConf + adjustment, 94));
}

function dots(form){return(form||[]).map(r=>`<div class="fd ${r}"></div>`).join('');}

function renderCard(f,h2h,hFm,aFm,precomputedModel){
  const hT=f.participants?.find(p=>p.meta?.location==='home');
  const aT=f.participants?.find(p=>p.meta?.location==='away');
  const lg=f.league?.name||'Football';
  const state=(f.state?.short_name||'').toUpperCase();
  const isLive=['LIVE','HT','ET','PEN','1H','2H'].includes(state);
  const isFT=['FT','AET','AP'].includes(state);
  const m=precomputedModel||runModel(f,h2h,hFm,aFm);
  const insight=buildInsight(m,hT?.name||'Home',aT?.name||'Away');
  const time=new Date(f.starting_at).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
  let midHtml=`<div class="vs-sep">VS</div>`;
  if(isLive||isFT){const hG=getGoals(f.scores,'home')??'‚Äì',aG=getGoals(f.scores,'away')??'‚Äì';midHtml=`<div class="live-score">${hG}:${aG}</div>`;}
  const bdgHtml=m.badges.map(b=>b.includes('VALUE')?`<span class="bdg bdg-val">${b}</span>`:b.includes('SAFE')?`<span class="bdg bdg-safe">${b}</span>`:b.includes('AVOID')?`<span class="bdg bdg-avoid">${b}</span>`:b.includes('RELIABLE')?`<span class="bdg bdg-rel">${b}</span>`:b.includes('HOT')?`<span class="bdg bdg-hot">${b}</span>`:b.includes('RISKY')?`<span class="bdg bdg-risky">${b}</span>`:'').join('');
  const h2hRows=(h2h||[]).slice(0,5).map(hm=>{
    const hp=hm.participants?.find(p=>p.meta?.location==='home'),ap=hm.participants?.find(p=>p.meta?.location==='away');
    const hG=getGoals(hm.scores,'home')??'?',aG=getGoals(hm.scores,'away')??'?';
    const isOurH=hp?.id===hT?.id,myG=isOurH?hG:aG,thG=isOurH?aG:hG;
    const res=myG>thG?'H':myG<thG?'A':'D';
    const dt=new Date(hm.starting_at).toLocaleDateString('en-GB',{month:'short',year:'2-digit'});
    return`<div class="ml-row"><span class="ml-dt">${dt}</span><span class="ml-t">${hp?.name||'?'} vs ${ap?.name||'?'}</span><span class="ml-sc">${hG}‚Äì${aG}</span><span class="rc rc${res}">${res}</span></div>`;
  }).join('')||'<div style="color:var(--dim);font-size:.72rem;padding:.4rem 0">No H2H data</div>';
  const l5=(tf,tid)=>[...tf].sort((a,b)=>new Date(b.starting_at)-new Date(a.starting_at)).slice(0,5).map(fx=>{
    const opp=fx.participants?.find(p=>p.id!==tid);
    const isH=fx.participants?.find(p=>p.meta?.location==='home')?.id===tid;
    const hG=getGoals(fx.scores,'home')??'?',aG=getGoals(fx.scores,'away')??'?';
    const my=isH?hG:aG,th=isH?aG:hG,r=my>th?'W':my<th?'L':'D';
    return`<div class="l5-row"><span class="l5-opp">${opp?.name||'?'}</span><span class="l5-sc">${my}‚Äì${th}</span><span class="rc ${r==='W'?'rcH':r==='L'?'rcA':'rcD'}">${r}</span></div>`;
  }).join('')||'<div style="color:var(--dim);font-size:.7rem">No data</div>';
  const hw=Math.round(m.hW/m.tot*100),dw=Math.round(m.dW/m.tot*100),aw=100-hw-dw;
  // Win probability % from Poisson (displayed on card face)
  const phw=Math.round(m.pResult.hw*100), pdw=Math.round(m.pResult.d*100), paw=Math.round(m.pResult.aw*100);
  // Rich stats tab content
  const stRows=(st,label,isHome)=>{
    if(!st) return `<div style="color:var(--dim);font-size:.7rem;padding:.4rem 0">No ${label} stats available</div>`;
    const split = isHome
      ? (st.homeAvgScored!==null?`Home: ${st.homeAvgScored.toFixed(1)} scored / ${st.homeAvgConceded.toFixed(1)} conc`:'')
      : (st.awayAvgScored!==null?`Away: ${st.awayAvgScored.toFixed(1)} scored / ${st.awayAvgConceded.toFixed(1)} conc`:'');
    const mom = st.momentum>0.5?'üìà Improving':st.momentum<-0.5?'üìâ Declining':'‚û°Ô∏è Steady';
    return `
      <div style="font-size:.6rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--dim);margin-bottom:.5rem">${label}</div>
      <div class="stats-grid">
        <div class="stat-box"><div class="sb-val" style="color:var(--gold)">${st.wAvgScored.toFixed(2)}</div><div class="sb-lbl">xG Scored</div></div>
        <div class="stat-box"><div class="sb-val" style="color:var(--red)">${st.wAvgConceded.toFixed(2)}</div><div class="sb-lbl">xG Conceded</div></div>
        <div class="stat-box"><div class="sb-val" style="color:var(--green)">${Math.round(st.winRate*100)}%</div><div class="sb-lbl">Win Rate</div></div>
        <div class="stat-box"><div class="sb-val">${Math.round(st.bttsRate*100)}%</div><div class="sb-lbl">BTTS Rate</div></div>
        <div class="stat-box"><div class="sb-val">${Math.round(st.csRate*100)}%</div><div class="sb-lbl">Clean Sheet</div></div>
        <div class="stat-box"><div class="sb-val">${Math.round(st.over25Rate*100)}%</div><div class="sb-lbl">Over 2.5</div></div>
      </div>
      ${split?`<div style="font-size:.65rem;color:var(--dim);margin-bottom:.5rem">${split}</div>`:''}
      <div style="font-size:.65rem;color:var(--dim);margin-bottom:.9rem">Momentum: ${mom} &nbsp;¬∑&nbsp; Scoring streak: ${st.scoringStreak} games &nbsp;¬∑&nbsp; Sample: ${st.matches} matches${st.hasMemory?` &nbsp;¬∑&nbsp; <span style="color:var(--purple)">üß† Memory: ${st.memWeight}% weight</span>`:''}</div>`;
  };
  return`<div class="pcard ${m.badgeClass}" id="c${f.id}" data-type="${m.tipType}">
  <div class="card-head">
    <div class="card-meta-row">
      <div class="league-tag">‚öΩ ${lg} ¬∑ ${time}${isLive?' &nbsp;<span class="bdg bdg-live">‚ö° LIVE</span>':''}${isFT?' &nbsp;<span style="font-size:.6rem;color:var(--dim)">FT</span>':''}</div>
      <div class="badges">${bdgHtml}</div>
    </div>
    <div class="teams-row">
      <div class="team"><div class="crest">${hT?.name?.charAt(0)||'?'}</div><div><div class="team-name">${hT?.name||'Home'}</div><div class="team-form">${dots(hFm.dots)}</div></div></div>
      <div class="vs-mid"><div class="vs-time">${time}</div>${midHtml}</div>
      <div class="team away"><div class="crest">${aT?.name?.charAt(0)||'?'}</div><div><div class="team-name">${aT?.name||'Away'}</div><div class="team-form" style="justify-content:flex-end">${dots(aFm.dots)}</div></div></div>
    </div>
  </div>
  <div class="prob-bar"><div class="prob-h" style="width:${phw}%"></div><div class="prob-d" style="width:${pdw}%"></div><div class="prob-a" style="width:${paw}%"></div></div>
  <div class="prob-labels">
    <div class="prob-lbl">H <span>${phw}%</span></div>
    <div class="prob-lbl" style="text-align:center">D <span>${pdw}%</span></div>
    <div class="prob-lbl" style="text-align:right">A <span>${paw}%</span></div>
  </div>
  <div class="insight${m.isHighVariance?' av':''}">
    <div class="insight-lbl">${m.isHighVariance?'‚ö†Ô∏è LOW CONFIDENCE':'‚ö° Model Intelligence'}</div>
    <div class="insight-txt">${insight}</div>
  </div>
  <div class="pred-row">
    <div><div class="tip-lbl">Value Tip</div><div class="tip-val tv-gold">${m.main}</div></div>
    ${m.safe?`<div><div class="tip-lbl">Safe Tip</div><div class="tip-val tv-grn">${m.safe}</div></div>`:''}
    <div class="conf-block"><div class="tip-lbl">Confidence</div><div class="conf-n">${m.conf}%</div><div class="conf-bar-w"><div class="conf-bar ${m.confClass}" style="width:${m.conf}%"></div></div></div>
  </div>
  <div class="odds-row"><div class="obt sel"><div class="ol">Home</div><div class="on">‚Äî</div></div><div class="obt"><div class="ol">Draw</div><div class="on">‚Äî</div></div><div class="obt"><div class="ol">Away</div><div class="on">‚Äî</div></div><div class="obt"><div class="ol">BTTS</div><div class="on">‚Äî</div></div><div class="obt"><div class="ol">O2.5</div><div class="on">‚Äî</div></div></div>
  <div class="exp-toggle" onclick="toggleExp(this)">
    <div class="etl">üìä Full Analysis ‚Äî H2H ¬∑ Last 5 ¬∑ Stats</div>
    <span class="earr">‚ñæ</span>
  </div>
  <div class="exp-panel">
    <div class="xtabs">
      <button class="xtab on" onclick="switchXTab(this,'xh2h${f.id}')">H2H</button>
      <button class="xtab" onclick="switchXTab(this,'xl5${f.id}')">Last 5</button>
      <button class="xtab" onclick="switchXTab(this,'xst${f.id}')">Stats</button>
    </div>
    <div id="xh2h${f.id}">
      <div class="h2h-sum">
        <div><div class="h2sn" style="color:var(--green)">${m.hW}</div><div class="h2sl">${hT?.name?.split(' ').pop()||'Home'}</div></div>
        <div><div class="h2sn">${m.dW}</div><div class="h2sl">Draw</div></div>
        <div><div class="h2sn" style="color:var(--red)">${m.aW}</div><div class="h2sl">${aT?.name?.split(' ').pop()||'Away'}</div></div>
        <div><div class="h2sn" style="color:var(--blue)">${m.tot}</div><div class="h2sl">Total</div></div>
      </div>
      <div class="h2h-bar"><div style="width:${hw}%;background:var(--blue)"></div><div style="width:${dw}%;background:var(--dim)"></div><div style="width:${aw}%;background:var(--orange)"></div></div>
      <div class="match-list">${h2hRows}</div>
    </div>
    <div id="xl5${f.id}" style="display:none">
      <div class="l5-grid">
        <div><div class="l5-ttl">${hT?.name||'Home'} ‚Äî Last 5</div>${l5(hFm.fixtures,hT?.id)}</div>
        <div><div class="l5-ttl">${aT?.name||'Away'} ‚Äî Last 5</div>${l5(aFm.fixtures,aT?.id)}</div>
      </div>
    </div>
    <div id="xst${f.id}" style="display:none">
      <div class="xg-row"><span class="xg-team">${hT?.name||'Home'} xG</span><span class="xg-val" style="color:var(--blue)">${m.hLambda.toFixed(2)}</span><div class="xg-bar"><div class="xg-fill" style="width:${Math.min(m.hLambda/3*100,100)}%;background:var(--blue)"></div></div></div>
      <div class="xg-row"><span class="xg-team">${aT?.name||'Away'} xG</span><span class="xg-val" style="color:var(--orange)">${m.aLambda.toFixed(2)}</span><div class="xg-bar"><div class="xg-fill" style="width:${Math.min(m.aLambda/3*100,100)}%;background:var(--orange)"></div></div></div>
      <div class="xg-row" style="margin-bottom:.9rem"><span class="xg-team">P(Over 2.5)</span><span class="xg-val">${Math.round(m.pOver25*100)}%</span><div class="xg-bar"><div class="xg-fill" style="width:${Math.round(m.pOver25*100)}%;background:var(--gold)"></div></div></div>
      <div class="xg-row" style="margin-bottom:.9rem"><span class="xg-team">P(BTTS)</span><span class="xg-val">${Math.round(m.pBTTS*100)}%</span><div class="xg-bar"><div class="xg-fill" style="width:${Math.round(m.pBTTS*100)}%;background:var(--green)"></div></div></div>
      ${stRows(m.hSt, hT?.name||'Home', true)}
      ${stRows(m.aSt, aT?.name||'Away', false)}
    </div>
  </div>
</div>`;
}

async function loadDate(date){
  const container=document.getElementById('predsContainer');
  buildDateBar(date);
  document.getElementById('dateLabel').textContent=fmtDate(date);
  document.getElementById('globalDate').value=date;
  document.getElementById('filterRow').style.display='none';
  document.getElementById('aiBanner').style.display='flex';
  document.getElementById('aiBannerTxt').textContent='Fetching fixtures‚Ä¶';
  container.innerHTML=`<div class="loader"><div class="spinner"></div><div class="loader-text">FETCHING LIVE FIXTURES</div><div class="load-sub">Pulling from Sportmonks‚Ä¶</div></div>`;
  try{
    const fd=await api(`/fixtures/date/${date}?include=participants;league;scores;state`);
    const fixtures=fd.data||[];
    document.getElementById('fixtureCountStat').querySelector('.stat-n').textContent=fixtures.length||'0';
    document.getElementById('lastUpdated').textContent=new Date().toLocaleTimeString('en-GB')+' ¬∑ Live';
    setPill('LIVE');
    if(!fixtures.length){
      document.getElementById('aiBanner').style.display='none';
      container.innerHTML=`<div class="empty-box">No fixtures for ${fmtDate(date)}.<br><span style="font-size:.72rem">Try another date.</span></div>`;
      return;
    }
    document.getElementById('aiBannerTxt').textContent=`Analysing ${fixtures.length} fixtures‚Ä¶`;
    const byLeague={};
    fixtures.forEach(f=>{const ln=f.league?.name||'Other';if(!byLeague[ln])byLeague[ln]=[];byLeague[ln].push(f);});
    let html='<div id="topPicksBanner"></div>';
    html+=`<div id="progressWrap" class="load-progress">Analysing 0 / ${fixtures.length} matches‚Ä¶</div><div class="prog-bar-wrap" style="margin:0 0 .8rem"><div class="prog-bar-fill" id="progBar" style="width:0%"></div></div>`;
    for(const[ln,lf]of Object.entries(byLeague)){
      html+=`<div class="lg-div"><div class="lg-div-label">‚öΩ ${ln}</div><div class="lg-div-line"></div></div>`;
      lf.forEach(f=>{html+=`<div id="w${f.id}"><div class="loader" style="padding:1.5rem"><div class="spinner" style="width:22px;height:22px"></div></div></div>`;});
    }
    container.innerHTML=html;
    document.getElementById('filterRow').style.display='flex';
    document.getElementById('aiBanner').style.display='none';

    // ‚îÄ‚îÄ Auto-resolve any pending predictions from past dates ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    fetch('/predictions/auto-resolve',{method:'POST'}).catch(()=>{});

    // ‚îÄ‚îÄ Load all cards in parallel with full error isolation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let done=0;
    const allModels=[];

    await Promise.allSettled(fixtures.map(async f=>{
      try{
        const hT=f.participants?.find(p=>p.meta?.location==='home');
        const aT=f.participants?.find(p=>p.meta?.location==='away');
        if(!hT||!aT){ done++; return; }

        // Fetch Sportmonks data (always needed)
        const[h2hD,hFixD,aFixD]=await Promise.all([
          api(`/fixtures/head-to-head/${hT.id}/${aT.id}?include=participants;scores&per_page=10`).then(r=>r.data||[]).catch(()=>[]),
          api(`/teams/${hT.id}/fixtures?per_page=20&sort=-starting_at&include=participants;scores`).then(r=>r.data||[]).catch(()=>[]),
          api(`/teams/${aT.id}/fixtures?per_page=20&sort=-starting_at&include=participants;scores`).then(r=>r.data||[]).catch(()=>[]),
        ]);

        // Fetch stored team memory (best-effort ‚Äî never blocks rendering)
        let hMemResp={found:false}, aMemResp={found:false};
        try{
          [hMemResp, aMemResp] = await Promise.all([
            fetch(`/memory/team/${hT.id}`).then(r=>r.ok?r.json():{found:false}).catch(()=>({found:false})),
            fetch(`/memory/team/${aT.id}`).then(r=>r.ok?r.json():{found:false}).catch(()=>({found:false})),
          ]);
        }catch(e){ /* memory fetch failed ‚Äî continue without it */ }

        const hFm=getForm(hFixD,hT.id), aFm=getForm(aFixD,aT.id);
        const freshHSt=getTeamStats(hFixD,hT.id), freshASt=getTeamStats(aFixD,aT.id);

        // Blend live stats with stored memory
        const blendStats=(fresh,mem)=>{
          if(!fresh) return null;
          if(!mem||!mem.found||!mem.team) return fresh;
          const stored=mem.team;
          const obsCount=stored.observationCount||1;
          const memWeight=Math.min(obsCount/50,0.4);
          const liveWeight=1-memWeight;
          const blend=(a,b)=>a*liveWeight+b*memWeight;
          return{
            ...fresh,
            wAvgScored:      blend(fresh.wAvgScored,    stored.wAvgScored    ??fresh.wAvgScored),
            wAvgConceded:    blend(fresh.wAvgConceded,  stored.wAvgConceded  ??fresh.wAvgConceded),
            winRate:         blend(fresh.winRate,        stored.winRate       ??fresh.winRate),
            drawRate:        blend(fresh.drawRate,       stored.drawRate      ??fresh.drawRate),
            bttsRate:        blend(fresh.bttsRate,       stored.bttsRate      ??fresh.bttsRate),
            over25Rate:      blend(fresh.over25Rate,     stored.over25Rate    ??fresh.over25Rate),
            csRate:          blend(fresh.csRate,         stored.csRate        ??fresh.csRate),
            ftsRate:         blend(fresh.ftsRate,        stored.ftsRate       ??fresh.ftsRate),
            homeAvgScored:   fresh.homeAvgScored   ??stored.homeAvgScored,
            homeAvgConceded: fresh.homeAvgConceded ??stored.homeAvgConceded,
            awayAvgScored:   fresh.awayAvgScored   ??stored.awayAvgScored,
            awayAvgConceded: fresh.awayAvgConceded ??stored.awayAvgConceded,
            momentum:fresh.momentum, scoringStreak:fresh.scoringStreak,
            observationCount:(stored.observationCount||0)+fresh.matches,
            hasMemory:true, memWeight:Math.round(memWeight*100),
          };
        };

        hFm.blendedStats=blendStats(freshHSt,hMemResp);
        aFm.blendedStats=blendStats(freshASt,aMemResp);

        // Run model & apply calibration
        const modelResult=runModel(f,h2hD,hFm,aFm);
        const calibConf=getCalibratedConf(modelResult.conf,modelResult.tipType);
        modelResult.conf=calibConf;
        modelResult.confClass=calibConf>74?'cb-hi':calibConf>54?'cb-mid':'cb-lo';

        allModels.push({f,modelResult,hT,aT});

        // Render card
        const wrap=document.getElementById(`w${f.id}`);
        if(wrap) wrap.outerHTML=renderCard(f,h2hD,hFm,aFm,modelResult);

        // Background learning (fire-and-forget ‚Äî never awaited)
        if(freshHSt) saveTeamMemory(hT.id,{...freshHSt,teamId:hT.id,teamName:hT.name});
        if(freshASt) saveTeamMemory(aT.id,{...freshASt,teamId:aT.id,teamName:aT.name});
        savePrediction(f,modelResult,hT,aT);

      }catch(cardErr){
        // Isolate failures ‚Äî one bad card never blocks others
        console.error(`[CARD FAIL] fixture ${f.id}:`,cardErr.message);
        const wrap=document.getElementById(`w${f.id}`);
        if(wrap) wrap.innerHTML=`<div style="padding:1rem;color:var(--dim);font-size:.72rem">Could not load this fixture.</div>`;
      }finally{
        // Progress always updates
        done++;
        const pct=Math.round(done/fixtures.length*100);
        const pw=document.getElementById('progressWrap');
        const pb=document.getElementById('progBar');
        if(pw) pw.textContent=`Analysing ${done} / ${fixtures.length} matches‚Ä¶`;
        if(pb) pb.style.width=pct+'%';
        if(done===fixtures.length&&pw) setTimeout(()=>pw.remove(),800);
      }
    }));

    // Build Top Picks banner ‚Äî top 3 VALUE tips by confidence
    const topPicks=allModels
      .filter(x=>x.modelResult.tipType==='val')
      .sort((a,b)=>b.modelResult.conf-a.modelResult.conf)
      .slice(0,3);
    const banner=document.getElementById('topPicksBanner');
    if(banner&&topPicks.length){
      banner.innerHTML=`<div class="top-picks">
        <div class="tp-title">üî• Top Picks Today</div>
        <div class="tp-list">${topPicks.map((x,i)=>`
          <div class="tp-row" onclick="document.getElementById('c${x.f.id}')?.scrollIntoView({behavior:'smooth',block:'center'})">
            <div class="tp-rank">${i+1}</div>
            <div class="tp-match">${x.hT.name} vs ${x.aT.name}</div>
            <div class="tp-tip">${x.modelResult.main}</div>
            <div class="tp-conf">${x.modelResult.conf}%</div>
          </div>`).join('')}
        </div>
      </div>`;
    }

    // Update filter tab counts
    const counts={all:0,val:0,safe:0,reliable:0};
    document.querySelectorAll('.pcard').forEach(c=>{
      counts.all++;
      const t=c.dataset.type;
      if(counts[t]!==undefined) counts[t]++;
    });
    document.querySelectorAll('.ftab').forEach(btn=>{
      const t=btn.onclick?.toString().match(/'(\w+)'/)?.[1];
      if(t&&counts[t]!==undefined) btn.textContent=btn.textContent.replace(/ \(\d+\)/,'')+` (${counts[t]})`;
    });

    applyFilter(currentFilter);
    showToast('‚úÖ Predictions Ready',`${fixtures.length} fixtures analysed ‚Äî ${topPicks.length} value picks found.`);
    // Refresh learning data after predictions are saved
    setTimeout(loadLearningData, 3000);
  }catch(err){
    console.error(err);
    setPill('ERROR',false);
    document.getElementById('aiBanner').style.display='none';
    container.innerHTML=`<div class="error-box">‚ö†Ô∏è API Error: ${err.message}<br><br>Check server logs on Render.</div>`;
  }
}

function applyFilter(type,btn){
  currentFilter=type;
  document.querySelectorAll('.ftab:not(#sortBtn)').forEach(t=>t.classList.remove('on'));
  (btn||document.querySelector('.ftab'))?.classList.add('on');
  document.querySelectorAll('.pcard').forEach(c=>{c.style.display=(type==='all'||c.dataset.type===type)?'block':'none';});
}

let sortedByConf=false;
function toggleSort(btn){
  sortedByConf=!sortedByConf;
  btn.classList.toggle('on',sortedByConf);
  btn.textContent=sortedByConf?'‚Üì Confidence':'‚Üï Confidence';
  const container=document.getElementById('predsContainer');
  const cards=[...container.querySelectorAll('.pcard')];
  if(sortedByConf){
    cards.sort((a,b)=>{
      const getConf=el=>{const m=el.querySelector('.conf-n');return m?parseInt(m.textContent):0;};
      return getConf(b)-getConf(a);
    });
    // Re-inject sorted cards after top picks
    const topBanner=document.getElementById('topPicksBanner');
    const lgDivs=container.querySelectorAll('.lg-div');
    lgDivs.forEach(d=>d.style.display='none');
    cards.forEach(c=>container.appendChild(c));
  } else {
    // Reload to restore league grouping
    loadDate(document.getElementById('globalDate').value);
  }
}

function toggleExp(btn){
  const panel=btn.closest('.pcard').querySelector('.exp-panel');
  const arr=btn.querySelector('.earr');
  panel.classList.toggle('open');arr.classList.toggle('open');
  btn.querySelector('.etl').textContent=panel.classList.contains('open')?'üìä Close Analysis':'üìä Full Analysis ‚Äî H2H ¬∑ Last 5 ¬∑ Stats';
}

function switchXTab(btn,tabId){
  const panel=btn.closest('.exp-panel');
  panel.querySelectorAll('.xtab').forEach(t=>t.classList.remove('on'));
  btn.classList.add('on');
  panel.querySelectorAll('[id]').forEach(c=>{if(c.id.startsWith('x'))c.style.display=c.id===tabId?'block':'none';});
}

(function(){const d=todayISO();document.getElementById('globalDate').value=d;buildDateBar(d);loadDate(d);loadLearningData();})();
</script>
</body>
</html>
